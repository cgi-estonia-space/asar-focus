
#include "orbit_state_vector.h"

#include "envisat_format/envisat_ph.h"

OrbitInfo InterpolateOrbit(const std::vector<OrbitInfo>& osv, double time_point) {
    int n = static_cast<int>(osv.size());
    OrbitInfo r = {};
    r.time_point = time_point;
    for (int i = 0; i < n; i++) {
        double mult = 1;
        for (int j = 0; j < n; j++) {
            if (i == j) continue;

            mult *= (time_point - osv.at(j).time_point) / (osv.at(i).time_point - osv.at(j).time_point);
        }

        r.x_pos += mult * osv[i].x_pos;
        r.y_pos += mult * osv[i].y_pos;
        r.z_pos += mult * osv[i].z_pos;
        r.x_vel += mult * osv[i].x_vel;
        r.y_vel += mult * osv[i].y_vel;
        r.z_vel += mult * osv[i].z_vel;
    }

    return r;
}

std::vector<OrbitStateVector> FindOrbits(boost::posix_time::ptime start, boost::posix_time::ptime stop) {
    std::vector<OrbitStateVector> osv = {
#if 1
        {StrToPtime("09-JAN-2004 19:49:14.569875"), 3687749.9335406013, 1299444.8144519862, 5993677.972680055,
         -4907.269755366022, -4183.9846562657, 3917.41234694791},
        {StrToPtime("09-JAN-2004 19:49:15.569875"), 3682840.3704227647, 1295260.4875603353, 5997592.126987583,
         -4911.855647134662, -4184.668298500505, 3910.89558931152},
        {StrToPtime("09-JAN-2004 19:49:16.569875"), 3677926.224017957, 1291075.4796196697, 6001499.762421136,
         -4916.436328464446, -4185.346754218983, 3904.3745990248744},
        {StrToPtime("09-JAN-2004 19:49:17.569875"), 3673007.4995394335, 1286889.7958164709, 6005400.874751611,
         -4921.01179369724, -4186.020023479114, 3897.8493831837773},
        {StrToPtime("09-JAN-2004 19:49:18.569875"), 3668084.2022061097, 1282703.4413371603, 6009295.459757015,
         -4925.582037180617, -4186.6881063452665, 3891.3199488883697},
        {StrToPtime("09-JAN-2004 19:49:19.569875"), 3663156.3371456973, 1278516.4212858323, 6013183.513298768,
         -4930.14705335746, -4187.351002901161, 3884.7863031147126},
        {StrToPtime("09-JAN-2004 19:49:20.569875"), 3658223.9097820176, 1274328.7410132743, 6017065.031016319,
         -4934.706836407369, -4188.008713197876, 3878.2484532282856},
        {StrToPtime("09-JAN-2004 19:49:21.569875"), 3653286.9252541573, 1270140.4056234395, 6020940.008785432,
         -4939.261380784743, -4188.66123733198, 3871.706406213854},
        {StrToPtime("09-JAN-2004 19:49:22.569875"), 3648345.3888035924, 1265951.4203024406, 6024808.442412546,
         -4943.8106808599605, -4189.308575393352, 3865.1601691887986},
        {StrToPtime("09-JAN-2004 19:49:23.569875"), 3643399.3056774293, 1261761.790236299, 6028670.327711208,
         -4948.354731009118, -4189.950727478225, 3858.6097492747886},
        {StrToPtime("09-JAN-2004 19:49:24.569875"), 3638448.6811283915, 1257571.5206109348, 6032525.660502098,
         -4952.893525614032, -4190.587693689222, 3852.055153597784},
        {StrToPtime("09-JAN-2004 19:49:25.569875"), 3633493.5204148246, 1253380.616612164, 6036374.4366130205,
         -4957.427059062257, -4191.21947413532, 3845.4963892880214},
        {StrToPtime("09-JAN-2004 19:49:26.569875"), 3628533.828800677, 1249189.0834256907, 6040216.651878911,
         -4961.955325747079, -4191.8460689318645, 3838.933463480011},
        {StrToPtime("09-JAN-2004 19:49:27.569875"), 3623569.611555506, 1244996.9262370989, 6044052.30214184,
         -4966.478320067522, -4192.467478200561, 3832.3663833125274},
        {StrToPtime("09-JAN-2004 19:49:28.569875"), 3618600.8739544624, 1240804.1502318494, 6047881.383251016,
         -4970.996036428356, -4193.0837020694835, 3825.7951559286016},
        {StrToPtime("09-JAN-2004 19:49:29.569875"), 3613627.62118055, 1236610.760512886, 6051703.891137828,
         -4975.50846932871, -4193.694740685014, 3819.219788346307},
        {StrToPtime("09-JAN-2004 19:49:30.569875"), 3608649.858715501, 1232416.7624301598, 6055519.8215155965,
         -4980.015613007571, -4194.300594163932, 3812.640287975519},
        {StrToPtime("09-JAN-2004 19:49:31.569875"), 3603667.5917535713, 1228222.1610863437, 6059329.170330129,
         -4984.5174619756845, -4194.901262665437, 3806.0566618428716},
        {StrToPtime("09-JAN-2004 19:49:32.569875"), 3598680.8255922506, 1224026.9616663365, 6063131.933459245,
         -4989.014010660874, -4195.496746343023, 3799.468917108362},
        {StrToPtime("09-JAN-2004 19:49:33.569875"), 3593689.5655345963, 1219831.1693548788, 6066928.106787917,
         -4993.505253496733, -4196.087045356539, 3792.877060936213},
        {StrToPtime("09-JAN-2004 19:49:34.569875"), 3588693.816889229, 1215634.789336549, 6070717.686208292,
         -4997.99118492264, -4196.672159872184, 3786.281100494865},
        {StrToPtime("09-JAN-2004 19:49:35.569875"), 3583693.584970329, 1211437.8267957557, 6074500.667619676,
         -5002.4717993837585, -4197.252090062509, 3779.681042956967},
        {StrToPtime("09-JAN-2004 19:49:36.569875"), 3578688.875097627, 1207240.2869167319, 6078277.046928555,
         -5006.947091331048, -4197.826836106401, 3773.076895499372},
        {StrToPtime("09-JAN-2004 19:49:37.569875"), 3573679.692596401, 1203042.1748835293, 6082046.820048594,
         -5011.4170552212645, -4198.396398189102, 3766.4686653031304},
        {StrToPtime("09-JAN-2004 19:49:38.569875"), 3568666.0427974705, 1198843.4958800112, 6085809.982900642,
         -5015.881685516974, -4198.960776502193, 3759.856359553486},
        {StrToPtime("09-JAN-2004 19:49:39.569875"), 3563647.93093856, 1194644.255007345, 6089566.531486457,
         -5020.340976774097, -4199.519971254526, 3753.2399853098386},
        {StrToPtime("09-JAN-2004 19:49:40.569875"), 3558625.3625587835, 1190444.4576140451, 6093316.461593622,
         -5024.794923291561, -4200.073982628386, 3746.619550025841},
        {StrToPtime("09-JAN-2004 19:49:41.569875"), 3553598.3429068024, 1186244.1088007104, 6097059.769238571,
         -5029.243519637213, -4200.622810845429, 3739.9950607690525},
        {StrToPtime("09-JAN-2004 19:49:42.569875"), 3548566.877335741, 1182043.213750558, 6100796.450370762,
         -5033.6867602967095, -4201.166456122562, 3733.3665247416748},
        {StrToPtime("09-JAN-2004 19:49:43.569875"), 3543530.9712039693, 1177841.7776463586, 6104526.500947074,
         -5038.124639761795, -4201.704918683063, 3726.733949149711},
        {StrToPtime("09-JAN-2004 19:49:44.569875"), 3538490.629875422, 1173639.8056707112, 6108249.916931531,
         -5042.557152529978, -4202.2381987565295, 3720.0973412033995},
        {StrToPtime("09-JAN-2004 19:49:45.569875"), 3533445.8587195403, 1169437.303005983, 6111966.69429538,
         -5046.984293104627, -4202.766296578891, 3713.4567081171244},
        {StrToPtime("09-JAN-2004 19:49:46.569875"), 3528396.6631112522, 1165234.274834302, 6115676.829017068,
         -5051.406055994947, -4203.289212392404, 3706.812057109402},
        {StrToPtime("09-JAN-2004 19:49:47.569875"), 3523343.04843098, 1161030.726337551, 6119380.317082276,
         -5055.822435716013, -4203.806946445651, 3700.1633954028794},
        {StrToPtime("09-JAN-2004 19:49:48.569875"), 3518285.0200646278, 1156826.662697362, 6123077.154483904,
         -5060.233426788762, -4204.319498993544, 3693.5107302243337},
        {StrToPtime("09-JAN-2004 19:49:49.569875"), 3513222.583304075, 1152622.0890125032, 6126767.337294507,
         -5064.639023826487, -4204.826870307228, 3686.8540686738384},
        {StrToPtime("09-JAN-2004 19:49:50.569875"), 3508155.7437450793, 1148417.0106292828, 6130450.8613764625,
         -5069.0392211887765, -4205.32906063433, 3680.1934182479345},
        {StrToPtime("09-JAN-2004 19:49:51.569875"), 3503084.50669054, 1144211.4326459435, 6134127.722816919,
         -5073.434013500784, -4205.826070258733, 3673.528786054988},
#endif
#if 0
{StrToPtime("30-MAR-2011 08:31:42.985850"), 4835842.06295424, 2773229.185550905, 4463564.530456022, 4891.748821813602, 703.2415278477437, -5720.916463952195},
{StrToPtime("30-MAR-2011 08:31:43.985850"), 4840731.231902924, 2773930.562014696, 4457841.169175299, 4886.588153649584, 699.5113780204565, -5725.8050451623485},
{StrToPtime("30-MAR-2011 08:31:44.985850"), 4845615.237247365, 2774628.2083210796, 4452112.922443253, 4881.42161329483, 695.7812134613519, -5730.687362043866},
{StrToPtime("30-MAR-2011 08:31:45.985850"), 4850494.07311822, 2775322.124457791, 4446379.796526922, 4876.249206381617, 692.051039099279, -5735.563409192948},
{StrToPtime("30-MAR-2011 08:31:46.985850"), 4855367.733651795, 2776012.310417497, 4440641.797698757, 4871.070938549639, 688.3208598623482, -5740.433181212926},
{StrToPtime("30-MAR-2011 08:31:47.985850"), 4860236.212990028, 2776698.766197789, 4434898.932236594, 4865.886815445982, 684.59068067792, -5745.296672714246},
{StrToPtime("30-MAR-2011 08:31:48.985850"), 4865099.5052805105, 2777381.4918011855, 4429151.206423668, 4860.6968427251195, 680.8605064725987, -5750.1538783145},
{StrToPtime("30-MAR-2011 08:31:49.985850"), 4869957.604676488, 2778060.487235129, 4423398.626548585, 4855.501026048893, 677.1303421722203, -5755.004792638409},
{StrToPtime("30-MAR-2011 08:31:50.985850"), 4874810.505336876, 2778735.7525119926, 4417641.198905336, 4850.299371086514, 673.4001927018471, -5759.849410317859},
{StrToPtime("30-MAR-2011 08:31:51.985850"), 4879658.201426256, 2779407.287649068, 4411878.929793275, 4845.091883514531, 669.6700629857548, -5764.687725991876},
{StrToPtime("30-MAR-2011 08:31:52.985850"), 4884500.687114889, 2780075.0926685724, 4406111.825517117, 4839.878569016831, 665.9399579474267, -5769.519734306646},
{StrToPtime("30-MAR-2011 08:31:53.985850"), 4889337.956578727, 2780739.1675976478, 4400339.892386926, 4834.659433284618, 662.2098825095416, -5774.345429915528},
{StrToPtime("30-MAR-2011 08:31:54.985850"), 4894170.003999436, 2781399.5124683552, 4394563.1367180785, 4829.434482016363, 658.4798415939408, -5779.164807479075},
{StrToPtime("30-MAR-2011 08:31:55.985850"), 4898996.823564298, 2782056.1273176726, 4388781.564831407, 4824.203720917948, 654.7498401217218, -5783.977861664927},
{StrToPtime("30-MAR-2011 08:31:56.985850"), 4903818.409472796, 2782709.0121309673, 4382995.182087533, 4818.967130245158, 651.0198721672824, -5788.784583863429},
{StrToPtime("30-MAR-2011 08:31:57.985850"), 4908634.755910867, 2783358.1670683594, 4377203.996752447, 4813.72476673138, 647.2899643835535, -5793.584975338498},
{StrToPtime("30-MAR-2011 08:31:58.985850"), 4913445.857089407, 2784003.592124975, 4371408.014196218, 4808.476610614521, 643.5601108294514, -5798.379027490644},
{StrToPtime("30-MAR-2011 08:31:59.985850"), 4918251.707218633, 2784645.287357474, 4365607.240760875, 4803.222667629084, 639.8303164225017, -5803.166735016279},
{StrToPtime("30-MAR-2011 08:32:00.985850"), 4923052.30051449, 2785283.2528274283, 4359801.682793732, 4797.962943516657, 636.1005860793056, -5807.948092619002},
{StrToPtime("30-MAR-2011 08:32:01.985850"), 4927847.631198684, 2785917.4886013293, 4353991.346647404, 4792.697444025916, 632.3709247155315, -5812.723095009601},
{StrToPtime("30-MAR-2011 08:32:02.985850"), 4932637.693874889, 2786547.9947999828, 4348176.2382226065, 4787.426174498114, 628.6413369528105, -5817.491737280559},
{StrToPtime("30-MAR-2011 08:32:03.985850"), 4937422.482023401, 2787174.7714006035, 4342356.364796532, 4782.149141524574, 624.9118282911388, -5822.254013407518},
{StrToPtime("30-MAR-2011 08:32:04.985850"), 4942201.990259901, 2787797.818534125, 4336531.732280737, 4776.86635046102, 621.1824033501799, -5827.00991849792},
{StrToPtime("30-MAR-2011 08:32:05.985850"), 4946976.2128291, 2788417.1362866876, 4330702.34704896, 4771.577807084333, 617.4530670418078, -5831.75944729132},
{StrToPtime("30-MAR-2011 08:32:06.985850"), 4951745.143981516, 2789032.7247493416, 4324868.215480154, 4766.283517178366, 613.7238242768923, -5836.5025945345105},
{StrToPtime("30-MAR-2011 08:32:07.985850"), 4956508.777973465, 2789644.584018054, 4319029.343958525, 4760.983486533981, 609.9946799653205, -5841.239354981507},
{StrToPtime("30-MAR-2011 08:32:08.985850"), 4961267.109067074, 2790252.714193699, 4313185.73887347, 4755.677720948977, 606.2656390159598, -5845.96972339356},
{StrToPtime("30-MAR-2011 08:32:09.985850"), 4966020.131530186, 2790857.1153820516, 4307337.406619745, 4750.366226228247, 602.5367063367519, -5850.693694539057},
{StrToPtime("30-MAR-2011 08:32:10.985850"), 4970767.839636543, 2791457.7876938013, 4301484.353597212, 4745.049008183532, 598.8078868345536, -5855.411263193701},
{StrToPtime("30-MAR-2011 08:32:11.985850"), 4975510.227665668, 2792054.731244544, 4295626.586210982, 4739.726072633561, 595.0791854152295, -5860.122424140391},
{StrToPtime("30-MAR-2011 08:32:12.985850"), 4980247.289902913, 2792647.94615478, 4289764.11087139, 4734.397425404002, 591.3506069836183, -5864.827172169259},
{StrToPtime("30-MAR-2011 08:32:13.985850"), 4984979.020639451, 2793237.432549912, 4283896.933993965, 4729.06307232745, 587.6221564435256, -5869.525502077669},
{StrToPtime("30-MAR-2011 08:32:14.985850"), 4989705.4141722955, 2793823.1905602496, 4278025.0619994365, 4723.723019243411, 583.8938386977154, -5874.217408670226},
{StrToPtime("30-MAR-2011 08:32:15.985850"), 4994426.464804299, 2794405.220320999, 4272148.501313721, 4718.3772719983, 580.1656586479036, -5878.902886758768},
{StrToPtime("30-MAR-2011 08:32:16.985850"), 4999142.166844204, 2794983.521972279, 4266267.258367878, 4713.025836445383, 576.4376211947238, -5883.581931162418},
{StrToPtime("30-MAR-2011 08:32:17.985850"), 5003852.514606504, 2795558.095659092, 4260381.339598265, 4707.668718444924, 572.7097312378222, -5888.254536707442},
{StrToPtime("30-MAR-2011 08:32:18.985850"), 5008557.502411628, 2796128.94153135, 4254490.751446322, 4702.305923863976, 568.9819936757233, -5892.920698227422},
{StrToPtime("30-MAR-2011 08:32:19.985850"), 5013257.124585938, 2796696.059743868, 4248595.500358569, 4696.937458576385, 565.2544134058212, -5897.580410563252},

#endif
    };

    std::cout << start << "\n";
    std::cout << stop << "\n";
    std::cout << osv.front().time << "\n";
    std::cout << osv.back().time << "\n";
    CHECK_BOOL(start >= osv.front().time && stop <= osv.back().time);
    return osv;
}

OrbitStateVector InterpolateOrbit(const std::vector<OrbitStateVector>& osv, boost::posix_time::ptime time) {
    std::vector<OrbitInfo> v;

    for (size_t i = 0; i < osv.size(); i++) {
        OrbitInfo o = {};
        o.time_point = (osv[i].time - osv.front().time).total_microseconds() / 1e6;
        o.x_pos = osv[i].x_pos;
        o.y_pos = osv[i].y_pos;
        o.z_pos = osv[i].z_pos;
        o.x_vel = osv[i].x_vel;
        o.y_vel = osv[i].y_vel;
        o.z_vel = osv[i].z_vel;
        v.push_back(o);
    }

    double tp = (time - osv.front().time).total_microseconds() / 1e6;

    auto res = InterpolateOrbit(v, tp);
    return {time, res.x_pos, res.y_pos, res.z_pos, res.x_vel, res.y_vel, res.z_vel};
}